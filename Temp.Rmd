---
title: "Temperature"
author: "Jenny Rogers"
date: "April 7, 2020"
output: html_document
---

```{r}
library(tidyverse)
library(sf)

```
For temperature, rather than just looking at the three water year types, we will look at all the futur years to show trends.
1. read in the three future temperature projectsion for MIROC CCSM4 and CanESM5 of the flow metrics
2. average the future projections together and add on the 95% CIs to the 7day min, mean, and max
3. 
4. Read in models for

The GCM stream temp preditions come from:
line 232 Air_temp_future CanESM2_stream_temp
line 760 Air_temp_future CCSM4_stream_temp
line 1038 Air_temp_future MIROC5_stream_temp

In this first chunk of code, we are reading in the stream temperature models, the baseline stream temperatures metrics and the projected stream temperature metrics for the three GCMs. The files are currently in other folders on the sccwrp L drive, so we read them in, and then re-save to this folder.  We average the metrics from each GCM and save the file as 'future'.

```{r}
# load("L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/mod_mean.rda")
# save(mod_mean, file = "mean_temp_model.rda")
load("mean_temp_model.rda")


# load("L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/mod_max.rda")
# save(mod_max, file = "max_temp_model.rda")
load("max_temp_model.rda")
# 
# load("L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/mod_min.rda")
# save(mod_min, file = "min_temp_model.rda")
load("min_temp_model.rda")

# load('L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/baseline_stream_temp_species_predictions.RData')
# baseline_stream_temp <- baseline_stream_temp_species_predictions %>%
#   select(1:8) %>% 
#   ungroup() %>% 
#   data.frame()
# baseline_stream_temp <- baseline_stream_temp[is.finite(rowSums(baseline_stream_temp)),]
# save(baseline_stream_temp, file = "baseline_stream_temp.RData", compress = "xz")
# rm(baseline_stream_temp_species_predictions)
load("baseline_stream_temp.RData")

# load('L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/MIROC5_stream_temp.RData')
# load('L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/CCSM4_stream_temp.RData')
# load('L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/CanESM2_stream_temp.RData')
# 
# future <- data.frame(
#   "COMID" = MIROC5_stream_temp$COMID,
#   "year" = MIROC5_stream_temp$year,
#   "Max_Wkly_Mean_StreamT" = (MIROC5_stream_temp$Max_Wkly_Mean_StreamT + CCSM4_stream_temp$Max_Wkly_Mean_StreamT + CanESM2_stream_temp$Max_Wkly_Mean_StreamT) / 3,
#   "Max_Wkl_Max_StreamT" = (MIROC5_stream_temp$Max_Wkl_Max_StreamT + CCSM4_stream_temp$Max_Wkl_Max_StreamT + CanESM2_stream_temp$Max_Wkl_Max_StreamT) / 3,
#   "Min_Wkl_Min_StreamT" = (MIROC5_stream_temp$Min_Wkl_Min_StreamT + CCSM4_stream_temp$Min_Wkl_Min_StreamT + CanESM2_stream_temp$Min_Wkl_Min_StreamT) / 3,
#   "Max_Wkl_Rng_StreamT" = (MIROC5_stream_temp$Max_Wkl_Rng_StreamT + CCSM4_stream_temp$Max_Wkl_Rng_StreamT + CanESM2_stream_temp$Max_Wkl_Rng_StreamT) / 3,
#   "Mean_Wkl_Rng_StreamT" = (MIROC5_stream_temp$Mean_Wkl_Rng_StreamT + CCSM4_stream_temp$Mean_Wkl_Rng_StreamT + CanESM2_stream_temp$Mean_Wkl_Rng_StreamT) / 3,
#   "Max_Wkl_Max_StreamT_grt_30_" = (MIROC5_stream_temp$Max_Wkl_Max_StreamT_grt_30_ + CCSM4_stream_temp$Max_Wkl_Max_StreamT_grt_30_ + CanESM2_stream_temp$Max_Wkl_Max_StreamT_grt_30_) / 3
# )
# 
# 
# future <- future[is.finite(rowSums(future)),]
# 
# save(future, file = "fut_strm_tmp.RData", compress = "xz")
# 
# rm(CanESM2_stream_temp, MIROC5_stream_temp, CCSM4_stream_temp)

load("fut_strm_tmp.RData")

```

In this next chunk of code, we will make a watershed and elevation to COMID conversion file, so we can summarize by watershed or elevation
```{r}
NHD <- st_read("C:/Users/JennyT/Documents/LitReview/RB4/WorkingData_3-16-18/NHDFLowline_Clip.shp")  %>% 
  filter(FTYPE == "StreamRiver") %>% 
  dplyr::select(COMID) %>% 
  st_zm()

wtrshd_bndry<- st_read("C:/Users/JennyT/Documents/LitReview/RB4/WorkingData_3-16-18/RB4watershedBoundaty.shp") %>% 
  dplyr::select(NAME) %>% 
  st_zm() %>% 
  rename(watershed = NAME)

#assign < 1000ft as low, 1000-5000 as mid, and higher than 5000 as high
elv <- read.csv("C:/Users/JennyT/Documents/LitReview/RB4/StreamCat/Elevation_Region18.csv") %>% 
  dplyr::select(COMID, ElevCat) %>% 
  mutate(elv = ifelse(ElevCat<304.8, "low",
                      ifelse(ElevCat>=304.8 & ElevCat<1524, "mid", "high")))

flow_wtrshed<- st_transform(NHD, crs = st_crs(wtrshd_bndry))
flow_wtrshed<- st_join(wtrshd_bndry, flow_wtrshed) %>% data.frame() %>% dplyr::select(-geometry)


future <- left_join(future, flow_wtrshed, by = "COMID") %>% 
  filter(!is.na(watershed))
future <- left_join(future, elv, by = "COMID")

baseline_stream_temp <- left_join(baseline_stream_temp, flow_wtrshed, by = "COMID") %>% 
  filter(!is.na(watershed))
baseline_stream_temp <- left_join(baseline_stream_temp, elv, by = "COMID")

rm(NHD, wtrshd_bndry, elv)

save(future, file = "fut_strm_tmp_wtrshd.RData", compress = "xz")
save(baseline_stream_temp, file = "baseline_stream_temp_wtrshd.RData", compress = "xz")


```


In this next chunk of code, we will add the 95% confidence intervals to the projections for the 7-day max, mean, and min
then we will rbind the basline years with the future years


```{r}

load("fut_strm_tmp_wtrshd.RData")

fut_CI <- future %>% 
  mutate(max_upr = Max_Wkl_Max_StreamT + 1.96 * sigma(mod_max),
         mean_upr = Max_Wkly_Mean_StreamT + 1.96 * sigma(mod_mean),
         min_upr = Min_Wkl_Min_StreamT + 1.96 * sigma(mod_min),
         max_lwr = Max_Wkl_Max_StreamT  - 1.96 * sigma(mod_max),
         mean_lwr = Max_Wkly_Mean_StreamT - 1.96 * sigma(mod_mean),
         min_lwr = Min_Wkl_Min_StreamT - 1.96 * sigma(mod_min)
         )

load("baseline_stream_temp_wtrshd.RData")

bslne_CI <- baseline_stream_temp %>% 
  mutate(max_upr = Max_Wkl_Max_StreamT + 1.96 * sigma(mod_max),
         mean_upr = Max_Wkly_Mean_StreamT + 1.96 * sigma(mod_mean),
         min_upr = Min_Wkl_Min_StreamT + 1.96 * sigma(mod_min),
         max_lwr = Max_Wkl_Max_StreamT  - 1.96 * sigma(mod_max),
         mean_lwr = Max_Wkly_Mean_StreamT - 1.96 * sigma(mod_mean),
         min_lwr = Min_Wkl_Min_StreamT - 1.96 * sigma(mod_min)
         )

strm_tmp_all <- rbind(bslne_CI, fut_CI)

```

Here well do box plots

```{r}


ggplot(data = strm_tmp_all, mapping = aes(x = watershed, y = Min_Wkl_Min_StreamT, group= as.factor(watershed)))+
  geom_violin()

```


In this next chunk of code, we will summarize the data by year, and then by elevation and year, and plot the trendlines

```{r}

yr <- strm_tmp_all %>% 
  group_by(year) %>% 
  summarise(
    avg = mean(Max_Wkly_Mean_StreamT),
    min = mean(Min_Wkl_Min_StreamT),
    max = mean(Max_Wkl_Max_StreamT),
    mean_upr = mean(mean_upr),
    min_upr = mean(min_upr),
    max_upr = mean(max_upr),
    mean_lwr = mean(mean_lwr),
    min_lwr = mean(min_lwr),
    max_lwr = mean(max_lwr)
  ) %>% 
  ungroup()


elevations <- strm_tmp_all %>% 
  group_by(elv, year) %>% 
  summarise(
    avg = mean(Max_Wkly_Mean_StreamT),
    min = mean(Min_Wkl_Min_StreamT),
    max = mean(Max_Wkl_Max_StreamT),
    mean_upr = mean(mean_upr),
    min_upr = mean(min_upr),
    max_upr = mean(max_upr),
    mean_lwr = mean(mean_lwr),
    min_lwr = mean(min_lwr),
    max_lwr = mean(max_lwr)
  )%>% 
  ungroup()


```

First, we will plot the stream temperature metrics by year along with the 95% CI. These line graphs show the average stream metric (ie the average value of all the COMIDs) over time.  

```{r}

#maximum 7-day average

ggplot(data = yr, mapping = aes(x = year, y = avg)) + 
  geom_line(lwd = 2)+
  geom_smooth(method = "lm")+
  geom_smooth(data = yr, mapping = aes(x = year, y = mean_upr), method = "lm")+
  geom_smooth(data = yr, mapping = aes(x = year, y = mean_lwr), method = "lm")+ 
  theme(panel.grid.major=element_line(colour="grey90"),
        panel.background = element_blank(),
        axis.title.x = element_text(size=30), 
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20))+
  scale_x_continuous(breaks = seq(1980, 2100, by = 10))+
  scale_y_continuous(breaks = seq(16, 34, by = 2))+
  labs(x = "Year", y = "Max 7-Day Mean (째C)")
  
#maximum 7-day maximum

ggplot(data = yr, mapping = aes(x = year, y = max)) + 
  geom_line(lwd = 2)+
  geom_smooth(method = "lm")+
  geom_smooth(data = yr, mapping = aes(x = year, y = max_upr), method = "lm")+
  geom_smooth(data = yr, mapping = aes(x = year, y = max_lwr), method = "lm")+ 
  theme(panel.grid.major=element_line(colour="grey90"),
        panel.background = element_blank(),
        axis.title.x = element_text(size=30), 
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20))+
  scale_x_continuous(breaks = seq(1980, 2100, by = 10))+
  scale_y_continuous(breaks = seq(22, 40, by = 2))+
  labs(x = "Year", y = "Max 7-Day Max (째C)")

#minimum 7-day min

ggplot(data = yr, mapping = aes(x = year, y = min)) + 
  geom_line(lwd = 2)+
  geom_smooth(method = "lm")+
  geom_smooth(data = yr, mapping = aes(x = year, y = min_upr), method = "lm")+
  geom_smooth(data = yr, mapping = aes(x = year, y = min_lwr), method = "lm")+ 
  theme(panel.grid.major=element_line(colour="grey90"),
        panel.background = element_blank(),
        axis.title.x = element_text(size=30), 
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20))+
  scale_x_continuous(breaks = seq(1980, 2100, by = 10))+
  scale_y_continuous(breaks = seq(4, 20, by = 2))+
  labs(x = "Year", y = "Min 7-Day Min (째C)")
  

```

In this next chunk of code, we will plot the stream temperature metrics by watershed-year, along with the 95% CI

```{r}

ggplot(data = elevations, mapping = aes(x = year, y = max, color = elv)) + 
  geom_line()+
  geom_smooth(method = "lm")+
  geom_smooth(mapping = aes(x = year, y = max_upr), method = "lm", alpha = 0.2)+
  geom_smooth(mapping = aes(x = year, y = max_lwr), method = "lm", alpha = 0.2)+ 
  theme(panel.grid.major=element_line(colour="grey90"),
        panel.background = element_blank(),
        axis.title.x = element_text(size=30), 
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20))+
  scale_x_continuous(breaks = seq(1980, 2100, by = 10))+
  scale_y_continuous(breaks = seq(16, 44, by = 2))+
  labs(x = "Year", y = "Max 7-Day Max (째C)")

```

In This code chunk, we are going to plot a map of metric changes and make a table of metric changes by elevation.
for the change, we are going to average all the years in the baseline and in the end-of-centry, and then subtract baseline from end of century. For the table, we will also group by elevation group, in addition to doing overall change.
```{r}

strm_tmp_chng <- strm_tmp_all %>% 
  mutate(decade = ifelse(year<2016, "baseline", 
                         ifelse(year>2016 & year < 2070, "mid", "end"))) %>% 
  filter(decade %in% c("baseline", "end")) %>% 
  group_by(COMID, decade) %>% 
  summarize(max = mean(Max_Wkl_Max_StreamT),
            min = mean(Min_Wkl_Min_StreamT),
            avg = mean(Max_Wkly_Mean_StreamT),
            rng = mean(Max_Wkl_Rng_StreamT),
            grt30 = mean(Max_Wkl_Max_StreamT_grt_30_)) %>% 
  ungroup()

chng <- data.frame(
  "COMID" = unique(strm_tmp_chng$COMID),
  "max" = strm_tmp_chng$max[strm_tmp_chng$decade=="end"] - strm_tmp_chng$max[strm_tmp_chng$decade=="baseline"],
  "min" = strm_tmp_chng$min[strm_tmp_chng$decade=="end"] - strm_tmp_chng$min[strm_tmp_chng$decade=="baseline"],
  "avg" = strm_tmp_chng$avg[strm_tmp_chng$decade=="end"] - strm_tmp_chng$avg[strm_tmp_chng$decade=="baseline"],
  "rng" = strm_tmp_chng$rng[strm_tmp_chng$decade=="end"] - strm_tmp_chng$rng[strm_tmp_chng$decade=="baseline"],
  "grt30" = strm_tmp_chng$grt30[strm_tmp_chng$decade=="end"] - strm_tmp_chng$grt30[strm_tmp_chng$decade=="baseline"]
)

```
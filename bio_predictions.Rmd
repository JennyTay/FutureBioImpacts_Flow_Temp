---
title: "Biology Predictions"
author: "Jenny Rogers"
date: "April 30, 2020"
output: html_document
---

```{r}

library(tidyverse)
library(sf)
library(lubridate)
library(RColorBrewer)
library(gridExtra)

```

In this document, we make predictions for the biology using the stream temp and the hydrologic metrics and the already built biological models.

first, with the temperature data, we run PCA on the training data so that we run a logistic regression with spp presence and absece data using PCA predictor variables. This lets us use all the temp varialbes for each spp, but ensures that the variables are not correlated.  Then we run the logistic regression..
```{r}

#load("L:/Flow ecology and climate change_ES/Jenny/AirTemp/Modeling/spp_tmp_train_dat.RData")
#save(species, file = "spp_tmp_dat.RData")
load("spp_tmp_dat.RData")
pca <- prcomp(species[,5:10], scale=TRUE)
summary(pca)

spp <- bind(species, pca$x)
spp <- spp %>% 
  select(name, occurrence, PC1, PC2)

trt <- spp %>% filter(name %in% "rainbow trout")
suc <- spp %>% filter(name %in% "santa ana sucker")
vir <- spp %>% filter(name %in% "least bell's vireo")
chb <- spp %>% filter(name %in% "arroyo chub")
toa <- spp %>% filter(name %in% "arroyo toad")
tur <- spp %>% filter(name %in% "southwestern pond turtle")


summary(trout_mdl <- glm(occurrence ~ PC1+PC2, family = "binomial",data = trt))
summary(sucker_mdl <- glm(occurrence ~ PC1+PC2, family = "binomial",data = suc))
summary(vireo_mdl <- glm(occurrence ~ PC1+PC2, family = "binomial",data = vir))
summary(chub_mdl <- glm(occurrence ~ PC1+PC2, family = "binomial",data = chb))
summary(toad_mdl <- glm(occurrence ~ PC1+PC2, family = "binomial",data = toa))
summary(turtle_mdl <- glm(occurrence ~ PC1+PC2, family = "binomial",data = tur))


```

In this code chunk, we read in the random forest models for each spp to predict P(occurrence) based on streamflow, and the streamflow metric and temperature dataframes


```{r}
#models based on streamflow metrics
load("mod_chub_rf.RData")
load("mod_vireo_rf.RData")
load("mod_toad_rf.RData")
load("mod_turtle_rf.RData")
load("mod_sucker_rf.RData")
load("mod_trout_rf.RData")


#load clusters and elevation data
clusters<- st_read("C:/Users/JennyT/Documents/LitReview/RB4/StreamCat/COMID clustering.shp") %>% 
  data.frame() %>% 
  select(COMID, clstrCt, dam) %>% 
  filter(clstrCt == 1 & dam == 0 )

load("elv_comid.RData")

#streamflow metric data
#baseline flow
load("bsflowmetest.RData")
baseline_flow <- bsflowmetest %>% 
  select(var, COMID, dtsl, est) %>% 
  filter(COMID %in% clusters$COMID) %>% 
  mutate(year = year(dtsl)) %>% 
  spread(var, est)

#future flow
load("flowmetdt2.RData")
future_flow <- flowmetdt2 %>% 
  select(var, COMID, dtsl, est) %>% 
  filter(COMID %in% clusters$COMID) %>% 
  mutate(year = year(dtsl)) %>% 
  spread(var, est)

flow <- bind_rows(baseline_flow, future_flow)
flow <- left_join(flow, elv, by = "COMID")

#temperature data
load("fut_strm_tmp_wtrshd.RData")
load("baseline_stream_temp_wtrshd.RData")
temp <- rbind(baseline_stream_temp, future) %>% 
  filter(COMID %in% clusters$COMID) #filter to remove COMIDs in urban areas

#filter to make the COMIDs line up with the temp (likely removing the coastline)
flow <- flow %>% filter(COMID %in% temp$COMID) 

rm(baseline_stream_temp, future, bsflowmetest, flowmetdt2, clusters, baseline_flow, future_flow, elv)

```


In this code chunk, we make the temperature data that we are making predicitons on in the same variables as the PC1 and PC2
```{r}


pred_tmp <- temp[,3:8]

std_dat <- scale(pred_tmp)

PC1 <- as.matrix(std_dat) %*% as.vector(pca$rotation[,1])

PC2 <- as.matrix(std_dat) %*% as.vector(pca$rotation[,2])

rm(pred_tmp)

temp <- cbind(temp, PC1, PC2)

```

Here we will use the temp models to make predictions for Temp and add in a column for baseline, mid-centiry, and end-of-centry

```{r}

temp$trout <- predict(trout_mdl, newdata = temp, type = "response")
temp$chub <- predict(chub_mdl, newdata = temp, type = "response")
temp$sucker <- predict(sucker_mdl, newdata = temp, type = "response")
temp$toad <- predict(toad_mdl, newdata = temp, type = "response")
temp$vireo <- predict(vireo_mdl, newdata = temp, type = "response")
temp$turtle <- predict(turtle_mdl, newdata = temp, type = "response")

temp$time <- ifelse(temp$year<=2014, "baseline", 
                    ifelse(temp$year >= 2022 & temp$year <= 2061, "mid", "end"))

```

In this chunk we will make a  figure of line graph showing mean and 5th 9th percentile probablilities in all years faceting for each spp.

```{r}

#plot for average (+high and low percentiles) annual probabilities across all COMID
timeline <- temp %>% 
  select(COMID, year, elv, trout, chub, sucker, toad, vireo, turtle) %>% 
  pivot_longer(cols = 4:9, names_to = "Species", values_to = "Probability") %>% 
  group_by(year, Species) %>% 
  summarise(avg = mean(Probability),
            upr_95 = quantile(Probability, probs = .95),
            lwr_05 = quantile(Probability, probs = .05)
    
  )


p <- ggplot(data = timeline, mapping = aes(x = year, y = avg)) + 
  geom_line(lwd = 2)+
  geom_smooth(method = "lm")+
  geom_line(data = timeline, mapping = aes(x = year, y = upr_95), color = "grey60")+
  geom_line(data = timeline, mapping = aes(x = year, y = lwr_05), color = "grey60")+
  theme(panel.grid.major=element_line(colour="grey90"),
        panel.background = element_blank(),
        axis.title.x = element_text(size=30), 
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(hjust = 1, size = 20),
        axis.text.y = element_text(size = 20),
        title = element_text(size = 30),
        strip.text = element_text(size = 30, face = "bold"),
        strip.background = element_rect(fill = "lightblue", colour = "black"))+
  scale_x_continuous(breaks = seq(1980, 2100, by = 20))+
  scale_y_continuous(breaks = seq(0, 1, by = 0.25))+
  labs(x = NULL, y = "Probability")+
  facet_wrap(vars(Species), nrow = 3)
 
  
ggsave("spp_prob_timeseries.tiff", plot = p, dpi = 300, width = 25, height = 20, compression = "lzw")

```


violine plots in change of the dist of change in prob from baseline to future for high and low elv  for each spp and a map showing change for each spp.
```{r}


df<- temp %>%
  select(COMID, year, elv, trout, chub, sucker, toad, vireo, turtle, time) %>% 
  filter(time %in% c("baseline", "end")) %>% 
  pivot_longer(cols = 4:9, names_to = "Species", values_to = "Probability") %>%
  group_by(Species, time, COMID)%>% 
  summarise(avgProb = mean(Probability)) %>% 
  ungroup()

chng <- 
  data.frame(
    "COMID" = unique(df$COMID),
    "chub_chg" = df$avgProb[df$Species == "chub" & df$time == "end"] - df$avgProb[df$Species == "chub" & df$time == "baseline"],
    "suc_chg" = df$avgProb[df$Species == "sucker" & df$time == "end"] - df$avgProb[df$Species == "sucker" & df$time == "baseline"],
    "trt_chg" = df$avgProb[df$Species == "trout" & df$time == "end"] - df$avgProb[df$Species == "trout" & df$time == "baseline"],
    "vir_chg" = df$avgProb[df$Species == "vireo" & df$time == "end"] - df$avgProb[df$Species == "vireo" & df$time == "baseline"],
    "toa_chg" = df$avgProb[df$Species == "toad" & df$time == "end"] - df$avgProb[df$Species == "toad" & df$time == "baseline"],
    "tur_chg" = df$avgProb[df$Species == "turtle" & df$time == "end"] - df$avgProb[df$Species == "turtle" & df$time == "baseline"]
    )
#calculate row averages and percentiles to get the average change across GCM and COMID in each metric
round(colMeans(chng),2)

round(apply(chng, 2, function (x){
  quantile(x, probs = 0.95)
}), 2)

round(apply(chng, 2, function (x){
  quantile(x, probs = 0.05)
}), 2)

#attach to spatial file
load("NHD_strm_rvr_map.RData")
chng <- left_join(NHD, chng, by = "COMID") %>% 
  filter(!is.na(chub_chg))

load("wtrshd_bundry.RData")
wtrshd_bndry<- st_transform(wtrshd_bndry, crs = st_crs(chng))

myPalette <- colorRampPalette(brewer.pal(9, "RdYlBu"))

a <- ggplot(data = chng, aes(col=chng$chub_chg)) +
  geom_sf(data = wtrshd_bndry, fill = "white", color = gray(.3), lwd = 1) +
  geom_sf()+
  scale_color_gradientn(colours = myPalette(100), limits = c(min(chng$chub_chg), max(chng$chub_chg)))+
  labs(col = "\u0394 P") +  ggtitle("(A)", subtitle = "Arroyo chub") + 
  theme(panel.grid.major=element_line(colour="transparent"),panel.background = element_blank(),
        axis.text = element_blank(),axis.ticks = element_blank(),
        text = element_text(size=30))
b <- ggplot(data = chng, aes(col=chng$suc_chg)) +
  geom_sf(data = wtrshd_bndry, fill = "white", color = gray(.3), lwd = 1) +
  geom_sf()+
  scale_color_gradientn(colours = myPalette(100), limits = c(min(chng$suc_chg), max(chng$suc_chg)))+
  labs(col = "\u0394 P") +  ggtitle("(B)", subtitle = "Santa Ana sucker") + 
  theme(panel.grid.major=element_line(colour="transparent"),panel.background = element_blank(),
        axis.text = element_blank(),axis.ticks = element_blank(),
        text = element_text(size=30))
c <- ggplot(data = chng, aes(col=chng$trt_chg)) +
  geom_sf(data = wtrshd_bndry, fill = "white", color = gray(.3), lwd = 1) +
  geom_sf()+
  scale_color_gradientn(colours = myPalette(100), limits = c(min(chng$trt_chg), max(chng$trt_chg)))+
  labs(col = "\u0394 P") +  ggtitle("(C)", subtitle = "rainbow trout") + 
  theme(panel.grid.major=element_line(colour="transparent"),panel.background = element_blank(),
        axis.text = element_blank(),axis.ticks = element_blank(),
        text = element_text(size=30))
d <- ggplot(data = chng, aes(col=chng$vir_chg)) +
  geom_sf(data = wtrshd_bndry, fill = "white", color = gray(.3), lwd = 1) +
  geom_sf()+
  scale_color_gradientn(colours = myPalette(100), limits = c(min(chng$vir_chg), max(chng$vir_chg)))+
  labs(col = "\u0394 P") +  ggtitle("(D)", subtitle = "Least Bell's vireo") + 
  theme(panel.grid.major=element_line(colour="transparent"),panel.background = element_blank(),
        axis.text = element_blank(),axis.ticks = element_blank(),
        text = element_text(size=30))
e <- ggplot(data = chng, aes(col=chng$toa_chg)) +
  geom_sf(data = wtrshd_bndry, fill = "white", color = gray(.3), lwd = 1) +
  geom_sf()+
  scale_color_gradientn(colours = myPalette(100), limits = c(min(chng$toa_chg), max(chng$toa_chg)))+
  labs(col = "\u0394 P") +  ggtitle("(E)", subtitle = "Arroyo toad") + 
  theme(panel.grid.major=element_line(colour="transparent"),panel.background = element_blank(),
        axis.text = element_blank(),axis.ticks = element_blank(),
        text = element_text(size=30))
f <- ggplot(data = chng, aes(col=chng$tur_chg)) +
  geom_sf(data = wtrshd_bndry, fill = "white", color = gray(.3), lwd = 1) +
  geom_sf()+
  scale_color_gradientn(colours = myPalette(100), limits = c(min(chng$tur_chg), max(chng$tur_chg)))+
  labs(col = "\u0394 P") +  ggtitle("(F)", subtitle = "Southwestern pond turtle") + 
  theme(panel.grid.major=element_line(colour="transparent"),panel.background = element_blank(),
        axis.text = element_blank(),axis.ticks = element_blank(),
        text = element_text(size=30))



comid_elv <- temp %>% 
  select(COMID, elv) %>% unique
chng <- left_join(chng, comid_elv, by = "COMID") %>% 
  data.frame() %>% 
  select(-geometry)

round(colMeans(chng[chng$elv=="high", 2:7]),2)
round(colMeans(chng[chng$elv=="low", 2:7]),2)
t.test(chng[chng$elv=="low", 2], chng[chng$elv=="high", 2])#max
t.test(chng[chng$elv=="low", 3], chng[chng$elv=="high", 3])#min
t.test(chng[chng$elv=="low", 4], chng[chng$elv=="high", 4])#avg

g <- ggplot(chng, aes(x = factor(elv, levels = c("low", "high")), y = chub_chg))+
  geom_violin()+geom_boxplot(width = .08)+
  labs(y="\u0394 P", x = "Elevation group")+
  ggtitle("(G)", subtitle = "Arroyo chub")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5))
h <- ggplot(chng, aes(x = factor(elv, levels = c("low", "high")), y = suc_chg))+
  geom_violin()+geom_boxplot(width = .08)+
  labs(y="\u0394 P", x = NULL)+
  ggtitle("(H)", subtitle = "Santa Ana sucker")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5))
i <- ggplot(chng, aes(x = factor(elv, levels = c("low", "high")), y = trt_chg))+
  geom_violin()+geom_boxplot(width = .08)+
  labs(y="\u0394 P", x = NULL)+
  ggtitle("(I)", subtitle = "rainbow trout")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5))
j <- ggplot(chng, aes(x = factor(elv, levels = c("low", "high")), y = vir_chg))+
  geom_violin()+geom_boxplot(width = .08)+
  labs(y="\u0394 P", x = NULL)+
  ggtitle("(J)", subtitle = "Least Bell's vireo")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5))
k <- ggplot(chng, aes(x = factor(elv, levels = c("low", "high")), y = toa_chg))+
  geom_violin()+geom_boxplot(width = .08)+
  labs(y="\u0394 P", x = NULL)+
  ggtitle("(K)", subtitle = "Arroyo toad")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5))
l <- ggplot(chng, aes(x = factor(elv, levels = c("low", "high")), y = tur_chg))+
  geom_violin()+geom_boxplot(width = .08)+
  labs(y="\u0394 P", x = NULL)+
  ggtitle("(L)", subtitle = "southwestern pond turtle")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5))

margin = theme(plot.margin = unit(c(5,5,5,5), "mm"))
p<-arrangeGrob(
  a + margin, g + margin, 
  b + margin, h + margin, 
  c + margin, i + margin, 
  d + margin, j + margin, 
  e + margin, k + margin, 
  f + margin, l + margin, 
  nrow = 6)
ggsave("bio_chng.tiff", plot = p, dpi = 300, width = 15, height = 30, compression = "lzw")



```

In this chunk of code, we plot the prob of occurrence based on the flow random forest.
we do bar plots to show the change in probability for wet, dry and average year.
```{r}


```

In the final code chunk, we want a plot that shows for each spp, the direction of change for temp, and the direction of change for flow (in each wet, dry and avg year). this could be similar to the violin plot in the original paper.
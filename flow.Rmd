---
title: "flow"
author: "Jenny Rogers"
date: "April 8, 2020"
output: html_document
---


```{r}

library(tidyverse)
library(lubridate)
library(sf)
library(gridExtra)


```



First, we want to determine the water year types that we chose in the baseline. first group by wateryear and then sum total precip. Then calculte the percentiles of the selected baseline yeras

```{r}
load("L:/Flow ecology and climate change_ES/Marcus/flowmetrics/data/bsext.RData")

baseline_prcip <- bsext %>% 
  mutate(year = year(date), 
         month = month(date),
         water_yr = ifelse(month>=10, year+1, year)) %>% 
  group_by(water_yr) %>% 
  summarise(total = sum(dly_prp)) %>% 
  ungroup() %>% 
  mutate(rank = min_rank(total))

low <- quantile(baseline_prcip$total, probs = 0.33)
med <- quantile(baseline_prcip$total, probs = 0.66)


baseline_prcip <- baseline_prcip %>% 
  mutate(third = ifelse(total<=low, 1,
                        ifelse(total>low & total<= med, 2, 3))) %>% 
  arrange(third, rank)


```

Look at the future years to determine the annual preciptitiaon percentiles in the water years we selected

```{r}
load("L:/Flow ecology and climate change_ES/Marcus/flowmetrics/data/CanESM2ext.Rdata")
load("L:/Flow ecology and climate change_ES/Marcus/flowmetrics/data/CCSM4ext.Rdata")
load("L:/Flow ecology and climate change_ES/Marcus/flowmetrics/data/MIROC5ext.Rdata")

head(CCSM4ext)
head(CanESM2ext)
head(MIROC5ext)

#average the future daily precip projections across the three GCMs-------------------

mean_dly_prp <- (MIROC5ext$dly_prp + CanESM2ext$dly_prp + CCSM4ext$dly_prp) / 3

avg <- data.frame("year" = year(MIROC5ext$date), 
                  "month" = month(MIROC5ext$date), 
                  "day" = day(MIROC5ext$date), 
                  "COMID" = MIROC5ext$COMID, 
                  "dly_prp" = mean_dly_prp)

#Water year function
water_yr <- function(year, month){
  ifelse(month >= 10, year + 1, year)
}

avg$wateryr <- water_yr(year = avg$year, month = avg$month)

str(avg)

#total preip in each comid per year
avg <- avg %>% 
  group_by(COMID, wateryr) %>% 
  summarise(annl_prp = sum(dly_prp)) %>% 
  ungroup()

#sum the total annual precip across all locations
avg <- avg %>% 
  group_by(wateryr) %>% 
  summarise(annl_prp_sum = sum(annl_prp)) %>% 
  ungroup()

unique(avg$wateryr)

#remove the ealier decades and 1982 because only half a year
avg <- avg %>% 
  filter(wateryr >= 2083) 

plot(avg$wateryr, avg$annl_prp_sum, type = "l")

#rank the precipitation amount
avg$rank <- min_rank(avg$annl_prp_sum)

#take period of record, sort by lowest to highest, highest 3rd would be wet, middle and lower.
first_third <- quantile(avg$annl_prp_sum, probs = 0.33)
secon_third <- quantile(avg$annl_prp_sum, probs = 0.66)
avg$third <- ifelse(avg$annl_prp_sum <=first_third, 1,
                    ifelse(avg$annl_prp_sum >= first_third & avg$annl_prp_sum <= secon_third, 2, 3))

# 2095 is the 2nd wet year
# 2090 is the dry wateryr, 
# 2100 is the moderate wateryr 

```



In the next code chunks, we want to calutate, tabulate, and plot the change in 5 hydrologic metrics from baseline to future.

first we will read in the baseline flow metrics and the future flow metrics
```{r}
NHD <- st_read("C:/Users/JennyT/Documents/LitReview/RB4/WorkingData_3-16-18/NHDFLowline_Clip.shp")  %>% 
  filter(FTYPE == "StreamRiver") %>% 
  dplyr::select(COMID) %>% 
  st_zm()

clusters<- st_read("C:/Users/JennyT/Documents/LitReview/RB4/StreamCat/COMID clustering.shp") %>% 
  data.frame() %>% 
  select(COMID, clstrCt, dam) %>% 
  filter(clstrCt == 1 & dam == 0 )

load("elv_comid.RData")


#baseline
load("bsflowmetest.RData")
baseline <- bsflowmetest %>% 
  select(var, COMID, dtsl, est) %>% 
  filter(var %in% c("x3_Hydroperiod", "x3_Q99", "x3_SFR", "x3_LowDur", "x3_HighNum"),
         COMID %in% clusters$COMID) %>% 
  mutate(year = year(dtsl),
         time = "baseline",
         type = ifelse(year ==1993, "wet",
                       ifelse(year == 2010, "mod", "dry"))) %>% 
  spread(var, est)

#future
load("flowmetdt2.RData")
future <- flowmetdt2 %>% 
  select(var, COMID, dtsl, est) %>% 
  filter(var %in% c("x3_Hydroperiod", "x3_Q99", "x3_SFR", "x3_LowDur", "x3_HighNum"),
         COMID %in% clusters$COMID) %>% 
  mutate(year = year(dtsl),
         time = "future",
         type = ifelse(year ==2095, "wet",
                       ifelse(year == 2100, "mod", "dry"))) %>% 
  spread(var, est)

flow <- bind_rows(baseline, future)
flow <- left_join(flow, elv, by = "COMID")

save(flow, file = "flowmet_all.RData")



```


in this next chunk of code, we will plot the means for each year type, baseline to future
```{r}

load("flowmet_all.RData")


a <- ggplot(data = flow, mapping = aes(x = factor(type, levels = c("dry", "mod", "wet")), y = x3_HighNum, fill = time))+
  geom_boxplot()+ scale_fill_manual(values=c("blue3", "darkorange3"))+
  labs(y="Number of Storms", x = NULL)+
  ggtitle("(A)")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5), 
        legend.title = element_blank(), legend.position = c(.225, 1),
    legend.justification = c("right", "top"),legend.box.background = element_rect(color="black", size=.5),
    legend.box.margin = margin(2, 2, 2, 2))

b <- ggplot(data = flow, mapping = aes(x = factor(type, levels = c("dry", "mod", "wet")), y = x3_LowDur, fill = time))+
  geom_boxplot()+ scale_fill_manual(values=c("blue3", "darkorange3"))+
  labs(y="Low Duration", x = NULL)+
  ggtitle("(B)")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5), legend.position = "none")

c <- ggplot(data = flow, mapping = aes(x = factor(type, levels = c("dry", "mod", "wet")), y = x3_Hydroperiod, fill = time))+
  geom_boxplot()+ scale_fill_manual(values=c("blue3", "darkorange3"))+
  labs(y="Hydroperiod", x = NULL)+
  ggtitle("(C)")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5),legend.position = "none")

d <- ggplot(data = flow, mapping = aes(x = factor(type, levels = c("dry", "mod", "wet")), y = x3_Q99, fill = time))+
  geom_boxplot()+ scale_fill_manual(values=c("blue3", "darkorange3"))+
  labs(y="Q99", x = NULL)+
  ggtitle("(D)")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5), legend.position = "none")

e <- ggplot(data = flow, mapping = aes(x = factor(type, levels = c("dry", "mod", "wet")), y = x3_SFR, fill = time))+
  geom_boxplot()+ scale_fill_manual(values=c("blue3", "darkorange3"))+
  labs(y="SFR", x = "Water Year Type")+
  ggtitle("(E)")+ 
  theme(text = element_text(size=30), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size=.5), legend.position = "none")


margin = theme(plot.margin = unit(c(5,7,5,5), "mm"))
p<-arrangeGrob(
  a + margin, b+ margin, c+ margin, d + margin, e + margin,
  nrow = 5)
ggsave("flowMetChng.tiff", plot = p, dpi = 300, width = 10, height = 25, compression = "lzw")
  
  

```



Make a table of change for each year type and each elevation

```{r}

flow_sum <- flow %>%
  group_by(type, elv) %>% 
  summarize(HiNuChg_mn = mean(x3_HighNum[time == "future"]-x3_HighNum[time == "baseline"], na.rm = T),
            HiNuChg_05 = quantile(x3_HighNum[time == "future"]-x3_HighNum[time == "baseline"], na.rm = T, probs = 0.05),
            HiNuChg_95 = quantile(x3_HighNum[time == "future"]-x3_HighNum[time == "baseline"], na.rm = T, probs = 0.95))



```
1. baseline flow metrics: 2010 (moderate), 1993 (wet), 2014 (dry)
2. future GCM averaged flow metrics: 2100 (moderate), 2095 (wet), and 2090 (dry) 
3. subtract the baseline year comids from the future year comids for each water year type and plot the violin plots of change for the 3 years types. this will replace table 8 and figure 6
4. table 9 - want to have the categores be high and low elevation instead of watershed. have it by water year type, and then baseline future. have an averaged value across all comids , and include the standard error reported